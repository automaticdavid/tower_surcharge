---
- name: Create Org
  tower_organization:
    name: REDHAT NETWORK ORGANIZATION 
    description: REDHAT NETWORK ORGANIZATION 
    state: present
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"

- name: Create inventory
  tower_inventory:
    name: Workshop Inventory
    organization: REDHAT NETWORK ORGANIZATION 
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    state: present

- name: Add Hosts
  tower_host:
    name: "{{ item }}"
    description: "Cisco {{ item }}"
    inventory: Workshop Inventory
    state: present
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    variables:
      ansible_user: ec2-user
      ansible_network_os: ios
      ansible_connection: network_cli
      private_ip: "{{ lookup('file', '/home/student1/networking-workshop/lab_inventory/hosts') 
                       | regex_search('^' + item +'.*$', multiline=True) 
                       |  regex_search('(private_ip=.*$)') 
                       | replace('private_ip=','') }}"
  with_items:
    - rtr1
    - rtr2
    - rtr3
    - rtr4

- name: Add tower group
  tower_group:
    name: dc1
    description: "Datacenter 1"
    inventory: "Workshop Inventory"
    state: present
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"

- name: Add tower group
  tower_group:
    name: dc2
    description: "Datacenter 2"
    inventory: "Workshop Inventory"
    state: present
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"

- name: Associate hosts to DC
  shell: |
       tower-cli config host "{{ tower_hostname }}"
       tower-cli config verify_ssl false
       tower-cli login {{ tower_username }} --password {{ tower_password }}
       tower-cli host associate --host rtr1  --group dc1
       tower-cli host associate --host rtr2  --group dc1
       tower-cli host associate --host rtr3  --group dc2
       tower-cli host associate --host rtr4  --group dc2

- name: Create Workshop Machine Credentials
  tower_credential:
    name: Workshop Credential
    organization: REDHAT NETWORK ORGANIZATION
    kind: ssh
    # ssh_key_data: "{{ lookup('file', '/home/student1/.ssh/aws-private.pem') }}"
    # https://github.com/ansible/ansible/issues/47832
    ssh_key_data: '/home/student1/.ssh/aws-private.pem'
    host: {}
    username: ec2-user
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    state: present

- name: Create Tower Credentials
  tower_credential:
    name: Tower Credential
    organization: REDHAT NETWORK ORGANIZATION
    kind: tower
    host: {}
    username: "{{ tower_username }}"
    password: "{{ tower_password }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    state: present

- name: Add Tower Project
  tower_project:
    name: Workshop Project 
    organization: REDHAT NETWORK ORGANIZATION 
    scm_type: git
    scm_url: https://github.com/automaticdavid/tower_workshop.git
    scm_branch: master
    scm_delete_on_update: yes
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    state: present

- name: Wait for sync
  pause: 
    seconds: 90 

- name: Create Job Template for User
  tower_job_template:
    name: Network-User
    inventory: Workshop Inventory
    project: Workshop Project
    job_type: run
    playbook: network_user.yml
    credential: Workshop Credential
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    state: present

- name: Create Job Template for Commands
  tower_job_template:
    name: Network-Commands
    inventory: Workshop Inventory
    project: Workshop Project
    job_type: run
    playbook: network_commands.yml
    credential: Workshop Credential
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    tower_host: "{{ tower_hostname }}"
    state: present

